name: Update README from template

on:
  push:
    paths:
      - 'templates/README.template.md'
      - '.github/workflows/scripts/generate-readme.sh'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq gettext-base

      - name: Make generate script executable
        run: chmod +x .github/workflows/scripts/generate-readme.sh

      - name: Generate README.md
        run: .github/workflows/scripts/generate-readme.sh

      - name: Update Docker Hub repository README
        env:
          DOCKERHUB_USERNAME: ${{ vars.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
          DOCKERHUB_REPO: geysermc-proxy
        run: |
          if [ -z "$DOCKERHUB_TOKEN" ] || [ -z "$DOCKERHUB_USERNAME" ]; then
            echo "Skipping Docker Hub update: missing credentials"
            exit 0
          fi

          JWT=$(curl -s -H "Content-Type: application/json" -X POST -d "{\"username\":\"$DOCKERHUB_USERNAME\",\"password\":\"$DOCKERHUB_TOKEN\"}" https://hub.docker.com/v2/users/login/ | jq -r .token)
          if [ -z "$JWT" ] || [ "$JWT" = "null" ]; then
            echo "Failed to obtain Docker Hub JWT"
            exit 1
          fi

          DATA=$(jq -n --arg fd "$(cat README.md)" '{full_description: $fd}')
          curl -s -X PATCH -H "Authorization: JWT $JWT" -H "Content-Type: application/json" -d "$DATA" "https://hub.docker.com/v2/repositories/${DOCKERHUB_USERNAME}/${DOCKERHUB_REPO}/" || { echo "Docker Hub update failed"; exit 1; }
          echo "Docker Hub README updated successfully"

      - name: Commit updated README.md
        uses: EndBug/add-and-commit@v9
        with:
          author_name: github-actions
          author_email: github-actions@users.noreply.github.com
          message: "chore: update README.md from template"
          add: "README.md"
          branch: ${{ github.ref_name }}
